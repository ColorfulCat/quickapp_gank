"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _asyncToGenerator(e){return function(){var r=e.apply(this,arguments);return new Promise(function(e,t){function n(o,s){try{var i=r[o](s),a=i.value}catch(e){return void t(e)}if(!i.done)return Promise.resolve(a).then(function(e){n("next",e)},function(e){n("throw",e)});e(a)}return n("next")})}}function getInspectorUrl(e){var r=e.ws;return"http://"+SERVER_IP_ADDR+"/inspector/inspector.html?ws="+encodeURI(r)+"&remoteFrontend=true&dockSide=undocked"}function untarInspectorTarFile(){var e=_config2.default.inspectorHtmlDir,r=_config2.default.inspectorTarBallFile;return new Promise(function(t,n){if(_fs2.default.existsSync(e))t({code:0,message:"Not untaring"});else try{var o=r;if(!_fs2.default.existsSync(o)){var s=new Error("No inspector.tar.gz on deployed path");throw n(s),s}return _tar2.default.x({file:o,cwd:_path2.default.dirname(o)}),t({code:0,message:"untaring done"})}catch(s){throw s}}).catch(function(e){_utils.colorconsole.error("### App Server ### 解压inspector.tar.gz出错\n"+JSON.stringify(e))})}function printInspectorUrl(e){var r=e.request.body,t=r.ws,n=r.application,o=r.status,s=e.request.body["protocol-version"];emitWSEvent(e.io,"appRegistered",{ws:t,application:n,protocolVer:s,status:o});var i=getInspectorUrl({ws:t});return _utils.colorconsole.info("### App Server ### 请访问以下链接进行调试：\n\n"+i+"\n"),i}function informToUpdateApk(e){_utils.colorconsole.warn("### App Server ### 应用加载器已有重要更新，请更新应用加载器"),e.io.sockets.emit("informUpdate",{})}function emitWSEvent(e,r,t){e.sockets.emit(r,t||{})}function getChromePathCrossPlatform(){switch(process.platform){case"linux":return new Promise(function(e,r){(0,_child_process.exec)("which google-chrome",function(t,n,o){t&&r(t);var s=n.replace(/\n/g,"");return e(s)})});case"darwin":return new Promise(function(e,r){return e("/Applications/Google Chrome.app")});case"win32":return new Promise(function(e,r){(0,_child_process.exec)('REG QUERY "HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\App Paths\\chrome.exe" /v path',function(t,n,o){t&&r(t);var s=n,i=s.split("\n"),a=void 0;i.every(function(e){var r=e.match(/path\s+reg_sz\s+(.+)/i);return!r||(a=r[1],!1)});var c=a;return e(_path2.default.resolve(c,"chrome.exe"))})});default:return null}}Object.defineProperty(exports,"__esModule",{value:!0}),exports.startChromeProc=exports.prepareStartServer=void 0;var prepareStartServer=exports.prepareStartServer=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,untarInspectorTarFile();case 3:e.next=8;break;case 5:e.prev=5,e.t0=e.catch(0),_utils.colorconsole.error("### App Server ### 解压inspector.tar.gz文件出错\n "+JSON.stringify(e.t0));case 8:case"end":return e.stop()}},e,this,[[0,5]])}));return function(){return e.apply(this,arguments)}}(),startChromeProc=exports.startChromeProc=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(r){var t,n,o,s,i;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,_utils.colorconsole.info("### App Server ### 准备启动调试"),t=_env.webAppEnv.ARGS.chromePath){e.next=7;break}return e.next=6,getChromePathCrossPlatform();case 6:t=e.sent;case 7:t&&_fs2.default.existsSync(t)||_utils.colorconsole.error("### App Server ### Chrome 路径不存在："+t),n="darwin"===process.platform,o=n?"open":_path2.default.resolve(t),s=n?[t,r]:[r],i=(0,_child_process.spawn)(o,s,{stdio:"ignore",detached:!0}),i.unref(),e.next=18;break;case 15:e.prev=15,e.t0=e.catch(0),_utils.colorconsole.error("### App Server ### 启动chrome进程失败: "+e.t0.message);case 18:case"end":return e.stop()}},e,this,[[0,15]])}));return function(r){return e.apply(this,arguments)}}();exports.getInspectorUrl=getInspectorUrl,exports.untarInspectorTarFile=untarInspectorTarFile,exports.printInspectorUrl=printInspectorUrl,exports.informToUpdateApk=informToUpdateApk,exports.emitWSEvent=emitWSEvent,exports.getChromePathCrossPlatform=getChromePathCrossPlatform;var _path=require("path"),_path2=_interopRequireDefault(_path),_fs=require("fs"),_fs2=_interopRequireDefault(_fs),_child_process=require("child_process"),_tar=require("tar"),_tar2=_interopRequireDefault(_tar),_utils=require("../../../lib/utils"),_env=require("../../env"),_config=require("../../../config"),_config2=_interopRequireDefault(_config),PORT=_env.webAppEnv.PORT,SERVER_IP_ADDR=(0,_utils.getIPv4IPAddress)()+(80===PORT?"":":"+PORT);