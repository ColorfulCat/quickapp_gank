"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _asyncToGenerator(e){return function(){var r=e.apply(this,arguments);return new Promise(function(e,t){function n(o,i){try{var u=r[o](i),a=u.value}catch(e){return void t(e)}if(!u.done)return Promise.resolve(a).then(function(e){n("next",e)},function(e){n("throw",e)});e(a)}return n("next")})}}Object.defineProperty(exports,"__esModule",{value:!0}),exports.logger=void 0;var index=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(r,t){var n,o,i,u,a,s,c;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(n=(process.env.NODE_MOUNTED_ROUTER||"").replace(/^\s*|\s*$/g,"")||"bundle",o=n.split(/\s+/),i=o.indexOf("bundle"),!((u=o.indexOf("debug"))>=0)){e.next=19;break}if(a=_config2.default.HTML_PAGE_PATH,s=_path2.default.join(a,"index.html"),!_fs2.default.existsSync(s)){e.next=14;break}return e.next=10,(0,_service.replaceIndexPage)();case 10:c=e.sent,r.body=c,e.next=17;break;case 14:return e.next=16,t();case 16:r.throw("404","Not Found for "+s+" file");case 17:e.next=20;break;case 19:i>=0?r.redirect(_apiDef2.default.qrCode):(r.type="text/plain",r.body="NO mounted Router!");case 20:case"end":return e.stop()}},e,this)}));return function(r,t){return e.apply(this,arguments)}}(),bundle=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(r,t){var n,o,i;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!_env.webAppEnv.ARGS.debugOnly){e.next=3;break}return _utils.colorconsole.info("### App Server ### In debugOnly mode, skip download bundle"),e.abrupt("return");case 3:return n=_config2.default.bundlePath,o=(0,_service.getCPProjName)(),i=_path2.default.join(n,o+".rpk"),_fs2.default.existsSync(i)||(i=_path2.default.join(n,o+".signed.rpk")),_fs2.default.existsSync(i)?(r.body=_fs2.default.createReadStream(i),r.set("Content-Type","text/plain")):(_utils.colorconsole.error("### App Server ### 未能找到"+i+"文件, 请检查是否正确运行了npm run build"),r.throw("404","Not Found for "+i+" file!")),e.next=10,t();case 10:case"end":return e.stop()}},e,this)}));return function(r,t){return e.apply(this,arguments)}}(),logger=exports.logger=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(r,t){var n,o;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,n=(0,_utils.getClientIPAddress)(r.req),o=(0,_utils.getIPv4IPAddress)(),n!==o&&(_utils.colorconsole.info("### App Server ### 记录进入http request: "+n),(0,_service.recordIncomingReqToFile)(n)),e.next=6,t();case 6:e.next=11;break;case 8:e.prev=8,e.t0=e.catch(0),_utils.colorconsole.error("### App Server ### 记录log出错: "+e.t0.message);case 11:case"end":return e.stop()}},e,this,[[0,8]])}));return function(r,t){return e.apply(this,arguments)}}(),qrCode=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(r,t){var n,o;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n="http://"+SERVER_IP_ADDR,o=_qrImage2.default.image(n,{size:9}),e.next=4,t();case 4:r.type="image/png",r.body=o;case 6:case"end":return e.stop()}},e,this)}));return function(r,t){return e.apply(this,arguments)}}(),_fs=require("fs"),_fs2=_interopRequireDefault(_fs),_path=require("path"),_path2=_interopRequireDefault(_path),_qrImage=require("qr-image"),_qrImage2=_interopRequireDefault(_qrImage),_utils=require("../../../lib/utils"),_env=require("../../env"),_apiDef=require("../apiDef"),_apiDef2=_interopRequireDefault(_apiDef),_config=require("../../../config"),_config2=_interopRequireDefault(_config),_service=require("../service"),PORT=_env.webAppEnv.PORT,SERVER_IP_ADDR=(0,_utils.getIPv4IPAddress)()+(80===PORT?"":":"+PORT);exports.default={index:index,bundle:bundle,qrCode:qrCode,logger:logger};